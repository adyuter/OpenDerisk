(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2151],{82151:function(e,t,l){"use strict";l.r(t),l.d(t,{default:function(){return eT}});var n,s=l(85893),a=l(41468),r=l(60778),i=l(43446),o=l(62418),c=l(2093),d=l(93967),u=l.n(d),x=l(39332),m=l(67294),h=l(39156),p=l(91085),f=l(50888),v=function(e){let{visible:t}=e;return t?(0,s.jsx)("div",{className:"absolute w-full h-full top-0 left-0 flex justify-center items-center z-10 bg-white dark:bg-black bg-opacity-50 dark:bg-opacity-50 backdrop-blur-sm text-3xl animate-fade animate-duration-200",children:(0,s.jsx)(f.Z,{})}):null},g=()=>{let{history:e,setHistory:t,chatId:l,model:n,docId:s}=(0,m.useContext)(a.p),{chat:o}=(0,i.Z)({queryAgentURL:"/knowledge/document/summary"}),c=(0,m.useCallback)(async e=>{let[,a]=await (0,r.Vx)((0,r.$i)(l)),i=[...a,{role:"human",context:"",model_name:n,order:0,time_stamp:0},{role:"view",context:"",model_name:n,order:0,time_stamp:0,retry:!0}],c=i.length-1;t([...i]),await o({data:{doc_id:e||s,model_name:n},chatId:l,onMessage:e=>{i[c].context=e,t([...i])}})},[e,n,s,l]);return c},j=l(87740),b=l(57132),w=l(66478),y=l(14553),_=l(45360),Z=l(83062),N=l(20640),C=l.n(N),k=l(96486),P=l(67421),S=l(27496),E=l(38289),R=l(77683),I=l(11163),D=l(82353),F=l(1051);function M(e){let{document:t}=e;switch(t.status){case"RUNNING":return(0,s.jsx)(D.Rp,{});case"FINISHED":default:return(0,s.jsx)(D.s2,{});case"FAILED":return(0,s.jsx)(F.Z,{})}}function O(e){let{documents:t,dbParam:l}=e,n=(0,I.useRouter)(),a=e=>{n.push("/knowledge/chunk/?spaceName=".concat(l,"&id=").concat(e))};return(null==t?void 0:t.length)?(0,s.jsx)("div",{className:"absolute flex overflow-scroll h-12 top-[-35px] w-full z-10",children:t.map(e=>{let t;switch(e.status){case"RUNNING":t="#2db7f5";break;case"FINISHED":default:t="#87d068";break;case"FAILED":t="#f50"}return(0,s.jsx)(Z.Z,{title:e.result,children:(0,s.jsxs)(R.ZP,{style:{color:t},onClick:()=>{a(e.id)},className:"shrink flex items-center mr-3",children:[(0,s.jsx)(M,{document:e}),e.doc_name]})},e.id)})}):null}var U=l(5392),L=l(84553);function $(e){let{dbParam:t,setDocId:l}=(0,m.useContext)(a.p),{onUploadFinish:n,handleFinish:i}=e,o=g(),[c,d]=(0,m.useState)(!1),u=async e=>{d(!0);let s=new FormData;s.append("doc_name",e.file.name),s.append("doc_file",e.file),s.append("doc_type","DOCUMENT");let a=await (0,r.Vx)((0,r.iG)(t||"default",s));if(!a[1]){d(!1);return}l(a[1]),n(),d(!1),null==i||i(!0),await o(a[1]),null==i||i(!1)};return(0,s.jsx)(L.default,{customRequest:u,showUploadList:!1,maxCount:1,multiple:!1,className:"absolute z-10 top-2 left-2",accept:".pdf,.ppt,.pptx,.xls,.xlsx,.doc,.docx,.txt,.md",children:(0,s.jsx)(R.ZP,{loading:c,size:"small",shape:"circle",icon:(0,s.jsx)(U.Z,{})})})}var A=l(87066),V=l(83454);let G=A.default.create({baseURL:null!==(n=V.env.API_BASE_URL)&&void 0!==n?n:""});G.defaults.timeout=1e4,G.interceptors.response.use(e=>e.data,e=>Promise.reject(e));let z={"content-type":"application/json","User-Id":(0,o.n5)()},H=(e,t)=>G.post(e,t,{headers:z}).then(e=>e).catch(e=>{_.ZP.error(e),Promise.reject(e)});var J=l(65654),q=l(2487),B=l(21532),T=l(55241),W=l(99859),Q=l(65217),K=l(44822);let X=e=>{let{data:t,loading:l,submit:n,close:a}=e,{t:r}=(0,P.$G)(),i=e=>()=>{n(e),a()};return(0,s.jsx)("div",{style:{maxHeight:400,overflow:"auto"},children:(0,s.jsx)(q.Z,{dataSource:null==t?void 0:t.data,loading:l,rowKey:e=>e.prompt_name,renderItem:e=>(0,s.jsx)(q.Z.Item,{onClick:i(e.content),children:(0,s.jsx)(Z.Z,{title:e.content,children:(0,s.jsx)(q.Z.Item.Meta,{style:{cursor:"copy"},title:e.prompt_name,description:r("Prompt_Info_Scene")+"：".concat(e.chat_scene,"，")+r("Prompt_Info_Sub_Scene")+"：".concat(e.sub_chat_scene)})})},e.prompt_name)})})};var Y=e=>{let{submit:t}=e,{t:l}=(0,P.$G)(),[n,a]=(0,m.useState)(!1),[r,i]=(0,m.useState)("common"),{data:o,loading:c}=(0,J.Z)(()=>H("/prompt/list",{prompt_type:r}),{refreshDeps:[r],onError:e=>{_.ZP.error(null==e?void 0:e.message)}});return(0,s.jsx)(B.ZP,{theme:{components:{Popover:{minWidth:250}}},children:(0,s.jsx)(T.Z,{title:(0,s.jsx)(W.Z.Item,{label:"Prompt "+l("Type"),children:(0,s.jsx)(Q.default,{style:{width:150},value:r,onChange:e=>{i(e)},options:[{label:l("Public")+" Prompts",value:"common"},{label:l("Private")+" Prompts",value:"private"}]})}),content:(0,s.jsx)(X,{data:o,loading:c,submit:t,close:()=>{a(!1)}}),placement:"topRight",trigger:"click",open:n,onOpenChange:e=>{a(e)},children:(0,s.jsx)(Z.Z,{title:l("Click_Select")+" Prompt",children:(0,s.jsx)(K.Z,{className:"bottom-[30%]"})})})})},ee=function(e){let{children:t,loading:l,onSubmit:n,handleFinish:i,placeholder:o,...c}=e,{dbParam:d,scene:u}=(0,m.useContext)(a.p),[x,h]=(0,m.useState)(""),p=(0,m.useMemo)(()=>"chat_knowledge"===u,[u]),[f,v]=(0,m.useState)([]),g=(0,m.useRef)(0);async function j(){if(!d)return null;let[e,t]=await (0,r.Vx)((0,r._Q)(d,{page:1,page_size:g.current}));v((null==t?void 0:t.data)||[])}(0,m.useEffect)(()=>{p&&j()},[d]);let b=async()=>{g.current+=1,await j()};return(0,s.jsxs)("div",{className:"flex-1 relative",children:[(0,s.jsx)(O,{documents:f,dbParam:d}),p&&(0,s.jsx)($,{handleFinish:i,onUploadFinish:b,className:"absolute z-10 top-2 left-2"}),(0,s.jsx)(E.default.TextArea,{className:"flex-1 ".concat(p?"pl-10":""," pr-10"),size:"large",value:x,autoSize:{minRows:1,maxRows:4},...c,onPressEnter:e=>{if(x.trim()&&13===e.keyCode){if(e.shiftKey){e.preventDefault(),h(e=>e+"\n");return}n(x),setTimeout(()=>{h("")},0)}},onChange:e=>{if("number"==typeof c.maxLength){h(e.target.value.substring(0,c.maxLength));return}h(e.target.value)},placeholder:o}),(0,s.jsx)(R.ZP,{className:"ml-2 flex items-center justify-center absolute right-0 bottom-0",size:"large",type:"text",loading:l,icon:(0,s.jsx)(S.Z,{}),onClick:()=>{n(x)}}),(0,s.jsx)(Y,{submit:e=>{h(x+e)}}),t]})},et=l(32975),el=l(28516),en=(0,m.memo)(function(e){var t;let{content:l}=e,{scene:n}=(0,m.useContext)(a.p),r="view"===l.role;return(0,s.jsx)("div",{className:u()("relative w-full p-2 md:p-4 rounded-xl break-words",{"bg-white dark:bg-[#232734]":r,"lg:w-full xl:w-full pl-0":["chat_with_db_execute","chat_dashboard"].includes(n)}),children:r?(0,s.jsx)(et.Z,{components:el.ZP,...el.dx,children:(0,el.CE)(null==(t=l.context)?void 0:t.replace(/<table(\w*=[^>]+)>/gi,"<table $1>").replace(/<tr(\w*=[^>]+)>/gi,"<tr $1>"))}):(0,s.jsx)("div",{className:"",children:l.context})})}),es=l(24019),ea=l(97937),er=l(63606),ei=l(50228),eo=l(87547),ec=l(89035),ed=l(66309),eu=l(81799);let ex={todo:{bgClass:"bg-gray-500",icon:(0,s.jsx)(es.Z,{className:"ml-2"})},runing:{bgClass:"bg-blue-500",icon:(0,s.jsx)(f.Z,{className:"ml-2"})},failed:{bgClass:"bg-red-500",icon:(0,s.jsx)(ea.Z,{className:"ml-2"})},completed:{bgClass:"bg-green-500",icon:(0,s.jsx)(er.Z,{className:"ml-2"})}};function em(e){return e.replaceAll("\\n","\n").replace(/<table(\w*=[^>]+)>/gi,"<table $1>").replace(/<tr(\w*=[^>]+)>/gi,"<tr $1>")}var eh=(0,m.memo)(function(e){let{children:t,content:l,isChartChat:n,onLinkClick:r}=e,{scene:i}=(0,m.useContext)(a.p),{context:o,model_name:c,role:d}=l,x="view"===d,{relations:h,value:p,cachePluginContext:f}=(0,m.useMemo)(()=>{if("string"!=typeof o)return{relations:[],value:"",cachePluginContext:[]};let[e,t]=o.split("	relations:"),l=t?t.split(","):[],n=[],s=0,a=e.replace(/<dbgpt-view[^>]*>[^<]*<\/dbgpt-view>/gi,e=>{try{var t;let l=e.replaceAll("\n","\\n").replace(/<[^>]*>|<\/[^>]*>/gm,""),a=JSON.parse(l),r="<custom-view>".concat(s,"</custom-view>");return n.push({...a,result:em(null!==(t=a.result)&&void 0!==t?t:"")}),s++,r}catch(t){return console.log(t.message,t),e}});return{relations:l,cachePluginContext:n,value:a}},[o]),v=(0,m.useMemo)(()=>({"custom-view"(e){var t;let{children:l}=e,n=+l.toString();if(!f[n])return l;let{name:a,status:r,err_msg:i,result:o}=f[n],{bgClass:c,icon:d}=null!==(t=ex[r])&&void 0!==t?t:{};return(0,s.jsxs)("div",{className:"bg-white dark:bg-[#212121] rounded-lg overflow-hidden my-2 flex flex-col lg:max-w-[80%]",children:[(0,s.jsxs)("div",{className:u()("flex px-4 md:px-6 py-2 items-center text-white text-sm",c),children:[a,d]}),o?(0,s.jsx)("div",{className:"px-4 md:px-6 py-4 text-sm",children:(0,s.jsx)(et.Z,{components:el.ZP,...el.dx,children:(0,el.CE)(null!=o?o:"")})}):(0,s.jsx)("div",{className:"px-4 md:px-6 py-4 text-sm",children:i})]})}}),[o,f]);return x||o?(0,s.jsxs)("div",{className:u()("relative flex flex-wrap w-full p-2 md:p-4 rounded-xl break-words",{"bg-white dark:bg-[#232734]":x,"lg:w-full xl:w-full pl-0":["chat_with_db_execute","chat_dashboard"].includes(i)}),children:[(0,s.jsx)("div",{className:"mr-2 flex flex-shrink-0 items-center justify-center h-7 w-7 rounded-full text-lg sm:mr-4",children:x?(0,eu.A)(c)||(0,s.jsx)(ei.Z,{}):(0,s.jsx)(eo.Z,{})}),(0,s.jsxs)("div",{className:"flex-1 overflow-hidden items-center text-md leading-8 pb-2",children:[!x&&"string"==typeof o&&o,x&&n&&"object"==typeof o&&(0,s.jsxs)("div",{children:["[".concat(o.template_name,"]: "),(0,s.jsxs)("span",{className:"text-theme-primary cursor-pointer",onClick:r,children:[(0,s.jsx)(ec.Z,{className:"mr-1"}),o.template_introduce||"More Details"]})]}),x&&"string"==typeof o&&(0,s.jsx)(et.Z,{components:{...el.ZP,...v},...el.dx,children:(0,el.CE)(em(p))}),!!(null==h?void 0:h.length)&&(0,s.jsx)("div",{className:"flex flex-wrap mt-2",children:null==h?void 0:h.map((e,t)=>(0,s.jsx)(ed.Z,{color:"#108ee9",children:e},e+t))})]}),t]}):(0,s.jsx)("div",{className:"h-12"})}),ep=l(59301),ef=l(41132),ev=l(74312),eg=l(3414),ej=l(72868),eb=l(59562),ew=l(25359),ey=l(7203),e_=l(48665),eZ=l(26047),eN=l(99056),eC=l(57814),ek=l(46300),eP=l(33028),eS=l(40911),eE=e=>{var t;let{conv_index:l,question:n,knowledge_space:i,select_param:o}=e,{t:c}=(0,P.$G)(),{chatId:d}=(0,m.useContext)(a.p),[u,x]=(0,m.useState)(""),[h,p]=(0,m.useState)(4),[f,v]=(0,m.useState)(""),g=(0,m.useRef)(null),[j,b]=_.ZP.useMessage(),N=(0,m.useCallback)((e,t)=>{t?(0,r.Vx)((0,r.Eb)(d,l)).then(e=>{var t,l,n,s;let a=null!==(t=e[1])&&void 0!==t?t:{};x(null!==(l=a.ques_type)&&void 0!==l?l:""),p(parseInt(null!==(n=a.score)&&void 0!==n?n:"4")),v(null!==(s=a.messages)&&void 0!==s?s:"")}).catch(e=>{console.log(e)}):(x(""),p(4),v(""))},[d,l]),C=(0,ev.Z)(eg.Z)(e=>{let{theme:t}=e;return{backgroundColor:"dark"===t.palette.mode?"#FBFCFD":"#0E0E10",...t.typography["body-sm"],padding:t.spacing(1),display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4,width:"100%",height:"100%"}});return(0,s.jsxs)(ej.L,{onOpenChange:N,children:[b,(0,s.jsx)(Z.Z,{title:c("Rating"),children:(0,s.jsx)(eb.Z,{slots:{root:y.ZP},slotProps:{root:{variant:"plain",color:"primary"}},sx:{borderRadius:40},children:(0,s.jsx)(ep.Z,{})})}),(0,s.jsxs)(ew.Z,{children:[(0,s.jsx)(ey.Z,{disabled:!0,sx:{minHeight:0}}),(0,s.jsx)(e_.Z,{sx:{width:"100%",maxWidth:350,display:"grid",gap:3,padding:1},children:(0,s.jsx)("form",{onSubmit:e=>{e.preventDefault(),(0,r.Vx)((0,r.VC)({data:{conv_uid:d,conv_index:l,question:n,knowledge_space:i,score:h,ques_type:u,messages:f}})).then(e=>{j.open({type:"success",content:"save success"})}).catch(e=>{j.open({type:"error",content:"save error"})})},children:(0,s.jsxs)(eZ.Z,{container:!0,spacing:.5,columns:13,sx:{flexGrow:1},children:[(0,s.jsx)(eZ.Z,{xs:3,children:(0,s.jsx)(C,{children:c("Q_A_Category")})}),(0,s.jsx)(eZ.Z,{xs:10,children:(0,s.jsx)(eN.Z,{action:g,value:u,placeholder:"Choose one…",onChange:(e,t)=>x(null!=t?t:""),...u&&{endDecorator:(0,s.jsx)(y.ZP,{size:"sm",variant:"plain",color:"neutral",onMouseDown:e=>{e.stopPropagation()},onClick:()=>{var e;x(""),null===(e=g.current)||void 0===e||e.focusVisible()},children:(0,s.jsx)(ef.Z,{})}),indicator:null},sx:{width:"100%"},children:o&&(null===(t=Object.keys(o))||void 0===t?void 0:t.map(e=>(0,s.jsx)(eC.Z,{value:e,children:o[e]},e)))})}),(0,s.jsx)(eZ.Z,{xs:3,children:(0,s.jsx)(C,{children:(0,s.jsx)(Z.Z,{title:(0,s.jsx)(e_.Z,{children:(0,s.jsx)("div",{children:c("feed_back_desc")})}),variant:"solid",placement:"left",children:c("Q_A_Rating")})})}),(0,s.jsx)(eZ.Z,{xs:10,sx:{pl:0,ml:0},children:(0,s.jsx)(ek.Z,{"aria-label":"Custom",step:1,min:0,max:5,valueLabelFormat:function(e){return({0:c("Lowest"),1:c("Missed"),2:c("Lost"),3:c("Incorrect"),4:c("Verbose"),5:c("Best")})[e]},valueLabelDisplay:"on",marks:[{value:0,label:"0"},{value:1,label:"1"},{value:2,label:"2"},{value:3,label:"3"},{value:4,label:"4"},{value:5,label:"5"}],sx:{width:"90%",pt:3,m:2,ml:1},onChange:e=>{var t;return p(null===(t=e.target)||void 0===t?void 0:t.value)},value:h})}),(0,s.jsx)(eZ.Z,{xs:13,children:(0,s.jsx)(eP.Z,{placeholder:c("Please_input_the_text"),value:f,onChange:e=>v(e.target.value),minRows:2,maxRows:4,endDecorator:(0,s.jsx)(eS.ZP,{level:"body-xs",sx:{ml:"auto"},children:c("input_count")+f.length+c("input_unit")}),sx:{width:"100%",fontSize:14}})}),(0,s.jsx)(eZ.Z,{xs:13,children:(0,s.jsx)(w.Z,{type:"submit",variant:"outlined",sx:{width:"100%",height:"100%"},children:c("submit")})})]})})})]})]})},eR=e=>{var t,l;let{messages:n,onSubmit:i,onFormatContent:d}=e,{dbParam:h,currentDialogue:f,scene:v,model:N,refreshDialogList:S,chatId:E,agent:R,docId:I}=(0,m.useContext)(a.p),{t:D}=(0,P.$G)(),F=(0,x.useSearchParams)(),M=null!==(t=F&&F.get("select_param"))&&void 0!==t?t:"",O=null!==(l=F&&F.get("spaceNameOriginal"))&&void 0!==l?l:"",[U,L]=(0,m.useState)(!1),[$,A]=(0,m.useState)(!1),[V,G]=(0,m.useState)(n),[z,H]=(0,m.useState)(""),[J,q]=(0,m.useState)(),B=(0,m.useRef)(null),T=(0,m.useMemo)(()=>"chat_dashboard"===v,[v]),W=g(),Q=(0,m.useMemo)(()=>{switch(v){case"chat_agent":return R;case"chat_excel":return null==f?void 0:f.select_param;case"chat_flow":return M;default:return O||h}},[v,R,f,h,O,M]),K=async e=>{if(!U&&e.trim()){if("chat_agent"===v&&!R){_.ZP.warning(D("choice_agent_tip"));return}try{L(!0),await i(e,{select_param:null!=Q?Q:""})}finally{L(!1)}}},X=e=>T&&d&&"string"==typeof e?d(e):e,[Y,et]=_.ZP.useMessage(),el=async e=>{let t=T&&d&&"string"==typeof e?d(e):e,l=null==t?void 0:t.replace(/\trelations:.*/g,""),n=C()(l);n?l?Y.open({type:"success",content:D("copy_success")}):Y.open({type:"warning",content:D("copy_nothing")}):Y.open({type:"error",content:D("copy_failed")})},es=async()=>{!U&&I&&(L(!0),await W(I),L(!1))};return(0,c.Z)(async()=>{let e=(0,o.a_)();e&&e.id===E&&(await K(e.message),S(),localStorage.removeItem(o.rU))},[E]),(0,m.useEffect)(()=>{let e=n;T&&(e=(0,k.cloneDeep)(n).map(e=>{if((null==e?void 0:e.role)==="view"&&"string"==typeof(null==e?void 0:e.context))try{e.context=JSON.parse(e.context)}catch(t){d&&(e.context=X(e.context))}return e})),G(e.filter(e=>["view","human"].includes(e.role)))},[T,n,d]),(0,m.useEffect)(()=>{(0,r.Vx)((0,r.Lu)()).then(e=>{var t;q(null!==(t=e[1])&&void 0!==t?t:{})}).catch(e=>{console.log(e)})},[]),(0,m.useEffect)(()=>{setTimeout(()=>{var e;null===(e=B.current)||void 0===e||e.scrollTo(0,B.current.scrollHeight)},50)},[n]),(0,s.jsxs)(s.Fragment,{children:[et,(0,s.jsx)("div",{ref:B,className:"flex flex-1 overflow-y-auto h-full w-full flex-col",children:(0,s.jsx)("div",{className:"flex items-center flex-1 flex-col text-sm leading-6 text-slate-900 dark:text-slate-300 sm:text-base sm:leading-7",children:V.length?V.map((e,t)=>{var l;return"chat_agent"===v?(0,s.jsx)(en,{content:e},t):(0,s.jsx)(eh,{content:e,isChartChat:T,onLinkClick:()=>{A(!0),H(JSON.stringify(null==e?void 0:e.context,null,2))},children:"view"===e.role&&(0,s.jsxs)("div",{className:"flex w-full border-t border-gray-200 dark:border-theme-dark",children:["chat_knowledge"===v&&e.retry?(0,s.jsxs)(w.Z,{onClick:es,slots:{root:y.ZP},slotProps:{root:{variant:"plain",color:"primary"}},children:[(0,s.jsx)(j.Z,{}),"\xa0",(0,s.jsx)("span",{className:"text-sm",children:D("Retry")})]}):null,(0,s.jsxs)("div",{className:"flex w-full flex-row-reverse",children:[(0,s.jsx)(eE,{select_param:J,conv_index:Math.ceil((t+1)/2),question:null===(l=null==V?void 0:V.filter(t=>(null==t?void 0:t.role)==="human"&&(null==t?void 0:t.order)===e.order)[0])||void 0===l?void 0:l.context,knowledge_space:O||h||""}),(0,s.jsx)(Z.Z,{title:D("Copy_Btn"),children:(0,s.jsx)(w.Z,{onClick:()=>el(null==e?void 0:e.context),slots:{root:y.ZP},slotProps:{root:{variant:"plain",color:"primary"}},sx:{borderRadius:40},children:(0,s.jsx)(b.Z,{})})})]})]})},t)}):(0,s.jsx)(p.Z,{description:"Start a conversation"})})}),(0,s.jsx)("div",{className:u()("relative sticky bottom-0 bg-theme-light dark:bg-theme-dark after:absolute after:-top-8 after:h-8 after:w-full after:bg-gradient-to-t after:from-theme-light after:to-transparent dark:after:from-theme-dark",{"cursor-not-allowed":"chat_excel"===v&&!(null==f?void 0:f.select_param)}),children:(0,s.jsxs)("div",{className:"flex flex-wrap w-full py-2 sm:pt-6 sm:pb-10 items-center",children:[N&&(0,s.jsx)("div",{className:"mr-2 flex",children:(0,eu.A)(N)}),(0,s.jsx)(ee,{loading:U,onSubmit:K,handleFinish:L})]})})]})},eI=l(16165),eD=l(96991),eF=l(78045);function eM(){let{isContract:e,setIsContract:t,scene:l}=(0,m.useContext)(a.p),n=l&&["chat_with_db_execute","chat_dashboard"].includes(l);return n?(0,s.jsxs)(eF.ZP.Group,{value:e,defaultValue:!0,buttonStyle:"solid",onChange:()=>{t(!e)},children:[(0,s.jsxs)(eF.ZP.Button,{value:!1,children:[(0,s.jsx)(eI.Z,{component:D.ig,className:"mr-1"}),"Preview"]}),(0,s.jsxs)(eF.ZP.Button,{value:!0,children:[(0,s.jsx)(eD.Z,{className:"mr-1"}),"Editor"]})]}):null}l(23293);var eO=function(){let{t:e}=(0,P.$G)(),{agent:t,setAgent:l}=(0,m.useContext)(a.p),{data:n=[]}=(0,J.Z)(async()=>{let[,e]=await (0,r.Vx)((0,r.H4)());return null!=e?e:[]});return(0,s.jsx)(Q.default,{className:"w-60",value:t,placeholder:e("Select_Plugins"),options:n.map(e=>({label:e.app_name,value:e.app_code})),allowClear:!0,onChange:e=>{null==l||l(e)}})},eU=l(29158),eL=l(16520),e$=l(49591),eA=l(88484),eV=function(e){var t;let{convUid:l,chatMode:n,onComplete:i,...o}=e,[c,d]=(0,m.useState)(!1),[u,x]=_.ZP.useMessage(),[h,p]=(0,m.useState)([]),[f,v]=(0,m.useState)(),{model:g}=(0,m.useContext)(a.p),{temperatureValue:j,maxNewTokensValue:b}=(0,m.useContext)(eL.ChatContentContext),w=async e=>{var t;if(!e){_.ZP.error("Please select the *.(csv|xlsx|xls) file");return}if(!/\.(csv|xlsx|xls)$/.test(null!==(t=e.file.name)&&void 0!==t?t:"")){_.ZP.error("File type must be csv, xlsx or xls");return}p([e.file])},y=async()=>{d(!0);try{let e=new FormData;e.append("doc_file",h[0]),u.open({content:"Uploading ".concat(h[0].name),type:"loading",duration:0});let[t]=await (0,r.Vx)((0,r.qn)({convUid:l,chatMode:n,data:e,model:g,temperatureValue:j,maxNewTokensValue:b,config:{timeout:36e5,onUploadProgress:e=>{let t=Math.ceil(e.loaded/(e.total||0)*100);v(t)}}}));if(t)return;_.ZP.success("success"),null==i||i()}catch(e){_.ZP.error((null==e?void 0:e.message)||"Upload Error")}finally{d(!1),u.destroy()}};return(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)("div",{className:"flex items-start gap-2",children:[x,(0,s.jsx)(Z.Z,{placement:"bottom",title:"File cannot be changed after upload",children:(0,s.jsx)(L.default,{disabled:c,className:"mr-1",beforeUpload:()=>!1,fileList:h,name:"file",accept:".csv,.xlsx,.xls",multiple:!1,onChange:w,showUploadList:{showDownloadIcon:!1,showPreviewIcon:!1,showRemoveIcon:!1},itemRender:()=>(0,s.jsx)(s.Fragment,{}),...o,children:(0,s.jsx)(R.ZP,{className:"flex justify-center items-center",type:"primary",disabled:c,icon:(0,s.jsx)(e$.Z,{}),children:"Select File"})})}),(0,s.jsx)(R.ZP,{type:"primary",loading:c,className:"flex justify-center items-center",disabled:!h.length,icon:(0,s.jsx)(eA.Z,{}),onClick:y,children:c?100===f?"Analysis":"Uploading":"Upload"}),!!h.length&&(0,s.jsxs)("div",{className:"mt-2 text-gray-500 text-sm flex items-center",onClick:()=>p([]),children:[(0,s.jsx)(eU.Z,{className:"mr-2"}),(0,s.jsx)("span",{children:null===(t=h[0])||void 0===t?void 0:t.name})]})]})})},eG=function(e){let{onComplete:t}=e,{currentDialogue:l,scene:n,chatId:r}=(0,m.useContext)(a.p);return"chat_excel"!==n?null:(0,s.jsx)("div",{className:"max-w-md h-full relative",children:l?(0,s.jsxs)("div",{className:"flex h-8 overflow-hidden rounded",children:[(0,s.jsx)("div",{className:"flex items-center justify-center px-2 bg-gray-600 text-lg",children:(0,s.jsx)(eU.Z,{className:"text-white"})}),(0,s.jsx)("div",{className:"flex items-center justify-center px-3 bg-gray-100 text-xs rounded-tr rounded-br dark:text-gray-800 truncate",children:l.select_param})]}):(0,s.jsx)(eV,{convUid:r,chatMode:n,onComplete:t})})},ez=l(23430),eH=function(){let{scene:e,dbParam:t,setDbParam:l}=(0,m.useContext)(a.p),[n,i]=(0,m.useState)([]);(0,c.Z)(async()=>{let[,t]=await (0,r.Vx)((0,r.vD)(e));i(null!=t?t:[])},[e]);let d=(0,m.useMemo)(()=>{var e;return null===(e=n.map)||void 0===e?void 0:e.call(n,e=>({name:e.param,...o.S$[e.type]}))},[n]);return((0,m.useEffect)(()=>{(null==d?void 0:d.length)&&!t&&l(d[0].name)},[d,l,t]),null==d?void 0:d.length)?(0,s.jsx)(Q.default,{value:t,className:"w-36",onChange:e=>{l(e)},children:d.map(e=>(0,s.jsxs)(Q.default.Option,{children:[(0,s.jsx)(ez.Z,{width:24,height:24,src:e.icon,label:e.label,className:"w-[1.5em] h-[1.5em] mr-1 inline-block mt-[-4px]"}),e.name]},e.name))}):null},eJ=function(e){let{refreshHistory:t,modelChange:l}=e,{scene:n,refreshDialogList:r}=(0,m.useContext)(a.p);return(0,s.jsxs)("div",{className:"w-full py-2 px-4 md:px-4 flex flex-wrap items-center justify-center gap-1 md:gap-4",children:[(0,s.jsx)(eu.Z,{onChange:l}),(0,s.jsx)(eH,{}),"chat_excel"===n&&(0,s.jsx)(eG,{onComplete:()=>{null==r||r(),null==t||t()}}),"chat_agent"===n&&(0,s.jsx)(eO,{}),(0,s.jsx)(eM,{})]})};let eq=e=>{if("string"!=typeof e)return e;if(e.startsWith("```vis-thinking")||e.includes("```vis-thinking")){let t=e.indexOf('{"');if(-1!==t){let l=e.substring(t);try{return JSON.parse(l)}catch(t){let e=l.replace(/```$/g,"").trim();try{return JSON.parse(e)}catch(e){return console.error("Error parsing cleaned JSON:",e),null}}}}try{return"string"==typeof e?JSON.parse(e):e}catch(t){return console.log("Not JSON format or vis-thinking format, returning original content"),e}},eB=e=>{if("string"!=typeof e)return e;if(e.startsWith("```vis-thinking")||e.includes("```vis-thinking")){let t=e.indexOf("```vis-thinking"),l=t+15,n=e.indexOf("```",l);if(-1!==n)return e.substring(t,n+3)}return e};var eT=()=>{var e;let t=(0,x.useSearchParams)(),{scene:l,chatId:n,model:d,agent:f,setModel:g,history:j,setHistory:b}=(0,m.useContext)(a.p),{chat:w}=(0,i.Z)({}),y=null!==(e=t&&t.get("initMessage"))&&void 0!==e?e:"",[_,Z]=(0,m.useState)(!1),[N,C]=(0,m.useState)(),k=async()=>{Z(!0);let[,e]=await (0,r.Vx)((0,r.$i)(n));b(null!=e?e:[]),Z(!1)},P=e=>{var t;let l=null===(t=e[e.length-1])||void 0===t?void 0:t.context;if(l)try{let e=eq(l),t="object"==typeof e?e:"string"==typeof l?JSON.parse(l):l;C((null==t?void 0:t.template_name)==="report"?null==t?void 0:t.charts:void 0)}catch(e){console.log(e),C([])}};(0,c.Z)(async()=>{let e=(0,o.a_)();e&&e.id===n||await k()},[y,n]),(0,m.useEffect)(()=>{var e,t;if(!j.length)return;let l=null===(e=null===(t=j.filter(e=>"view"===e.role))||void 0===t?void 0:t.slice(-1))||void 0===e?void 0:e[0];(null==l?void 0:l.model_name)&&g(l.model_name),P(j)},[j.length]),(0,m.useEffect)(()=>()=>{b([])},[]);let S=(0,m.useCallback)((e,t)=>new Promise(s=>{let a=[...j,{role:"human",context:e,model_name:d,order:0,time_stamp:0},{role:"view",context:"",model_name:d,order:0,time_stamp:0}],r=a.length-1;b([...a]),w({data:{...t,chat_mode:l||"chat_normal",model_name:d,user_input:e},chatId:n,onMessage:e=>{(null==t?void 0:t.incremental)?a[r].context+=e:a[r].context=e,b([...a])},onDone:()=>{P(a),s()},onClose:()=>{P(a),s()},onError:e=>{a[r].context=e,b([...a]),s()}})}),[j,w,n,d,f,l]);return(0,s.jsxs)("div",{className:"flex flex-col h-screen w-full overflow-hidden",children:[(0,s.jsx)(v,{visible:_}),(0,s.jsx)("div",{className:"flex-none",children:(0,s.jsx)(eJ,{refreshHistory:k,modelChange:e=>{g(e)}})}),(0,s.jsxs)("div",{className:"flex-auto flex overflow-hidden",children:[!!(null==N?void 0:N.length)&&(0,s.jsx)("div",{className:u()("overflow-auto",{"w-full h-1/2 md:h-full md:w-3/4 pb-4 md:pr-4":"chat_dashboard"===l}),children:(0,s.jsx)(h.ZP,{chartsData:N})}),!(null==N?void 0:N.length)&&"chat_dashboard"===l&&(0,s.jsx)("div",{className:u()("flex items-center justify-center",{"w-full h-1/2 md:h-full md:w-3/4":"chat_dashboard"===l}),children:(0,s.jsx)(p.Z,{})}),(0,s.jsx)("div",{className:u()("flex flex-col overflow-hidden",{"w-full h-1/2 md:h-full md:w-1/4 border-t md:border-t-0 md:border-l dark:border-gray-800":"chat_dashboard"===l,"w-full h-full px-4 lg:px-8":"chat_dashboard"!==l}),children:(0,s.jsx)("div",{className:"h-full overflow-hidden",children:(0,s.jsx)(eR,{messages:j,onSubmit:S,onFormatContent:eB})})})]})]})}},81799:function(e,t,l){"use strict";l.d(t,{A:function(){return x}});var n=l(85893),s=l(41468),a=l(19284),r=l(65217),i=l(25675),o=l.n(i),c=l(67294),d=l(67421);let u="/models/huggingface.svg";function x(e,t){var l,s;let{width:r,height:i}=t||{};return e?(0,n.jsx)(o(),{className:"rounded-full border border-gray-200 object-contain bg-white inline-block",width:r||24,height:i||24,src:(null===(l=a.Hf[e])||void 0===l?void 0:l.icon)||u,alt:"llm"},(null===(s=a.Hf[e])||void 0===s?void 0:s.icon)||u):null}t.Z=function(e){let{onChange:t}=e,{t:l}=(0,d.$G)(),{modelList:i,model:o}=(0,c.useContext)(s.p);return!i||i.length<=0?null:(0,n.jsx)(r.default,{value:o,placeholder:l("choose_model"),className:"w-52",onChange:e=>{null==t||t(e)},children:i.map(e=>{var t;return(0,n.jsx)(r.default.Option,{children:(0,n.jsxs)("div",{className:"flex items-center",children:[x(e),(0,n.jsx)("span",{className:"ml-2",children:(null===(t=a.Hf[e])||void 0===t?void 0:t.label)||e})]})},e)})})}},91085:function(e,t,l){"use strict";var n=l(85893),s=l(32983),a=l(77683),r=l(93967),i=l.n(r),o=l(67421);t.Z=function(e){let{className:t,error:l,description:r,refresh:c}=e,{t:d}=(0,o.$G)();return(0,n.jsx)(s.Z,{image:"/empty.png",imageStyle:{width:320,height:196,margin:"0 auto",maxWidth:"100%",maxHeight:"100%"},className:i()("flex items-center justify-center flex-col h-full w-full",t),description:l?(0,n.jsx)(a.ZP,{type:"primary",onClick:c,children:d("try_again")}):null!=r?r:d("no_data")})}},23293:function(){}}]);